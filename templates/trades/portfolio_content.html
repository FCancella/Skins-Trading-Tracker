{% load currency %}
{% load form_extras %}

<style>
  /* Adiciona um cursor de ponteiro para indicar que os cabeçalhos são clicáveis */
  .table th.sortable {
    cursor: pointer;
    position: relative;
    user-select: none;
  }

  /* Estilos para as setas de ordenação */
  .table th.sortable::after,
  .table th.sortable::before {
    content: "";
    position: absolute;
    right: 4px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .table th.sortable::before {
    bottom: 50%;
    margin-bottom: 1px;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-bottom: 5px solid;
  }

  .table th.sortable::after {
    top: 50%;
    margin-top: 1px;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid;
  }

  /* Mostra a seta correta dependendo da direção da ordenação */
  .table th.sort-asc::before,
  .table th.sort-desc::after {
    opacity: 1;
  }
</style>

<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card">
      <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseSummary" aria-expanded="true" aria-controls="collapseSummary">Summary</div>
      <div class="collapse show" id="collapseSummary">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Total</div>
              {% comment %} <div class="lbl">NAV</div> {% endcomment %}
              <div class="val">{{ summary.nav|currency_brl }}</div>
              <small class="text-muted-2">Caixa: {{ summary.cash|currency_brl }}</small>
              {% comment %} <small class="text-muted-2">Cash: {{ summary.cash|currency_brl }}</small> {% endcomment %}
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Inventário</div>
              {% comment %} <div class="lbl">MTM</div> {% endcomment %}
              <div class="val">{{ summary.mtm_value|currency_brl }}</div>
              <small class="text-muted-2">Custo: {{ summary.cost_basis|currency_brl }}</small>
              {% comment %} <small class="text-muted-2">Cost: {{ summary.cost_basis|currency_brl }}</small> {% endcomment %}
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">ROI</div>
              <div class="val">{{ summary.roi_percent|pct }}</div>
              <small class="text-muted-2">Investido: {{ summary.invested|currency_brl }}</small>
              {% comment %} <small class="text-muted-2">IC: {{ summary.invested|currency_brl }}</small> {% endcomment %}
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Profit</div>
              {% comment %} <div class="lbl">PnL</div> {% endcomment %}
              <div class="val">{{ summary.realized_pnl_value|currency_brl }}</div>
              <small class="text-muted-2">% médio: {{ summary.average_pnl_percent|pct }}</small>
              {% comment %} <small class="text-muted-2">Average PnL: {{ summary.average_pnl_percent|pct }}</small> {% endcomment %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseChart" aria-expanded="false" aria-controls="collapseChart">Profit history</div>
      <div class="collapse" id="collapseChart">
        <div class="card-body">
          <canvas id="pnlChart" style="height:200px; max-height:300px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  {% if not is_observer %}
    {% include 'trades/add_forms.html' %}
    {% include 'trades/bulk_add_form.html' %}
  {% endif %}
</div>

<div class="card mt-3">
  <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapsePortfolio" aria-expanded="true" aria-controls="collapsePortfolio">Portfolio</div>
  <div class="collapse show" id="collapsePortfolio">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle" id="portfolioTable">
          <thead>
            <tr>
              <th class="sortable" data-sort-type="text">Item</th>
              <th class="sortable" data-sort-type="currency">Buy Price</th>
              <th class="sortable" data-sort-type="currency">Sell Price</th>
              <th class="sortable" data-sort-type="text">Buy Source</th>
              <th class="sortable" data-sort-type="text">Sell Source</th>
              <th class="sortable" data-sort-type="date">Buy Date</th>
              <th class="sortable" data-sort-type="date">Sell Date</th>
              <th class="sortable" data-sort-type="currency">Profit</th>
              {% comment %} <th class="sortable" data-sort-type="currency">PnL</th> {% endcomment %}
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for group in trade_data.grouped_open_trades %}
            <tr>
              <td class="fw-medium">{{ group.trade.item_name }} {% if group.quantity > 1 %}<span class="text-muted-2">({{ group.quantity }})</span>{% endif %}</td>
              <td>{{ group.trade.buy_price|currency_brl }}</td>
              <td>{{ group.trade.sell_price|currency_brl|default:"—" }}</td>
              <td>{{ group.trade.get_buy_source_display }}</td>
              <td>{{ group.trade.get_sell_source_display|default:"" }}</td>
              <td>
                <span class="{{ group.trade.days_until_tradable|yesno:',cell-stale' }}">{{ group.trade.buy_date|date:"d/m/y" }}</span>
                {% if group.trade.days_until_tradable %}
                <small class="text-muted-2 fs-7">{{ group.trade.days_until_tradable }}d</small>
                {% endif %}
              </td>
              <td>{% if group.trade.sell_date %}{{ group.trade.sell_date|date:"d/m/y" }}{% endif %}</td>
              <td>—</td>
              <td>
                <button type="button" class="badge status-open badge-button" 
                  {% if not is_observer %}data-bs-toggle="modal" data-bs-target="#editModal-{{ group.trade.id }}"{% else %}disabled{% endif %}>
                  Open
                </button>
              </td>
            </tr>
            {% if not is_observer %}
              {% include 'trades/edit_modal.html' with trade=group.trade %}
            {% endif %}
            {% endfor %}

            {% for trade in trade_data.closed_trades %}
            <tr>
              <td class="fw-medium">{{ trade.item_name }}</td>
              <td>{{ trade.buy_price|currency_brl }}</td>
              <td>{{ trade.sell_price|currency_brl|default:"—" }}</td>
              <td>{{ trade.get_buy_source_display }}</td>
              <td>{{ trade.get_sell_source_display|default:"" }}</td>
              <td>{{ trade.buy_date|date:"d/m/y" }}</td>
              <td>
                {% if trade.sell_date %}
                  {{ trade.sell_date|date:"d/m/y" }}
                  {% if trade.days_until_payment is not None %}<small class="text-muted-2 fs-7">{{ trade.days_until_payment }}d</small>{% endif %}
                {% endif %}
              </td>
              <td>
                {% if trade.pnl_value is not None %}
                <span class="fw-semibold">{{ trade.pnl_value|currency_brl }} <small class="text-muted-2 fs-7">({{ trade.pnl_percent|pct }})</small></span>
                {% else %} — {% endif %}
              </td>
              <td>
                <button type="button" class="badge status-closed badge-button" 
                  {% if not is_observer %}data-bs-toggle="modal" data-bs-target="#editModal-{{ trade.id }}"{% else %}disabled{% endif %}>
                  Closed
                </button>
              </td>
            </tr>
            {% if not is_observer %}
              {% include 'trades/edit_modal.html' with trade=trade %}
            {% endif %}
            {% endfor %}

            {% if not trade_data.grouped_open_trades and not trade_data.closed_trades %}
            <tr><td colspan="9" class="text-center text-muted-2">No trades yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% if not is_observer %}
<div class="card mt-3">
    {% include 'trades/investment_section.html' %}
</div>

<div class="card mt-3">
    <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseCashSource" aria-expanded="true" aria-controls="collapseCashSource">Cash per Source</div>
    <div class="collapse show" id="collapseCashSource">
        <div class="card-body">
            <canvas id="cashSourceChart" style="height:200px; max-height:300px;"></canvas>
        </div>
    </div>
</div>
{% endif %}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const pnlData = {{ pnl_data|safe }};
    if (pnlData && pnlData.length > 0) {
      const labels = pnlData.map(item => item.date);
      const values = pnlData.map(item => item.pnl);
      const ctx = document.getElementById('pnlChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{
          label: 'Accumulated PnL (R$)', data: values,
          borderColor: 'rgba(122, 43, 246, 0.8)', backgroundColor: 'rgba(122, 43, 246, 0.2)',
          tension: 0.3, fill: true,
        }]},
        options: { responsive: true, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false }}}
      });
    }

    const cashSourceData = {{ cash_per_source_data|safe }};
    if (cashSourceData && cashSourceData.labels.length > 0) {
        const ctx = document.getElementById('cashSourceChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: cashSourceData.labels,
                datasets: [{
                    label: 'Cash per Source (R$)',
                    data: cashSourceData.values,
                    backgroundColor: 'rgba(255, 78, 205, 0.2)',
                    borderColor: 'rgba(255, 78, 205, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    const portfolioTable = document.getElementById('portfolioTable');
    const headers = portfolioTable.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: 'asc' };

    headers.forEach((header, index) => {
      header.addEventListener('click', () => {
        const sortType = header.dataset.sortType;
        if (currentSort.column === index) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = index;
          currentSort.direction = 'asc';
        }
        sortTable(index, sortType, currentSort.direction);
        updateHeaderStyles();
      });
    });

    function updateHeaderStyles() {
      headers.forEach((header, index) => {
        header.classList.remove('sort-asc', 'sort-desc');
        if (index === currentSort.column) {
          header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    function parseValue(value, type) {
        if (type === 'currency') {
            if (value === '—') return -Infinity; // Trata valores vazios
            return parseFloat(value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
        }
        if (type === 'date') {
            if (!value) return null;
            const parts = value.trim().split(' ')[0].split('/');
            if (parts.length === 3) {
              return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return null;
        }
        return value.toLowerCase();
    }

    function sortTable(columnIndex, sortType, direction) {
      const tbody = portfolioTable.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      const sortedRows = rows.sort((a, b) => {
        const aVal = parseValue(a.cells[columnIndex].textContent, sortType);
        const bVal = parseValue(b.cells[columnIndex].textContent, sortType);

        if (aVal === null) return 1;
        if (bVal === null) return -1;
        
        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });

      tbody.innerHTML = '';
      sortedRows.forEach(row => tbody.appendChild(row));
    }
  });
</script>