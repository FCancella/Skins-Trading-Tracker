{% load currency %}
{% load form_extras %}

{% if notifications %}
<div class="notification-box mb-4">
  {% for item in notifications %}
    <div class="notification-day-group">
      <div class="notification-day">
        {% if item.day == today %}Today{% elif item.day == tomorrow %}Tomorrow{% else %}{{ item.day|date:"l, M d" }}{% endif %}
      </div>
      <div class="notification-details">
        {% if item.tradable_count > 0 %}
        <div class="notification-item">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 S0 0 1 10 0v4"></path></svg>
          <span class="count">{{ item.tradable_count }}</span>
          <span class="label">Trade Lock</span>
        </div>
        {% endif %}
        {% if item.payment_count > 0 %}
        <div class="notification-item">
           <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
          <span class="count">{{ item.payment_count }}</span>
          <span class="label">Trade Protection</span>
        </div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<style>
  .notification-box {
    background: rgba(18, 18, 26, 0.7);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 0.75rem 1.5rem;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .notification-day-group {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    min-height: 50px;
  }
  .notification-day-group:not(:last-child) {
    border-bottom: 1px solid var(--border);
  }
  .notification-day {
    font-weight: 700;
    color: var(--fg-1);
    min-width: 140px; /* Ajuste a largura conforme necessário */
    text-align: left;
  }
  .notification-details {
    display: flex;
    gap: 1.5rem;
  }
  .notification-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .notification-item .icon {
    width: 16px;
    height: 16px;
    color: var(--pink); /* Cor restaurada */
  }
  .notification-item .count {
    font-weight: 700;
    font-size: 1rem;
    color: var(--fg-1);
  }
  .notification-item .label {
    color: var(--fg-2);
    font-size: 0.9rem;
  }
</style>
{% endif %}



<style>
  /* Adiciona um cursor de ponteiro para indicar que os cabeçalhos são clicáveis */
  .table th.sortable {
    cursor: pointer;
    position: relative;
    user-select: none;
  }

  /* Estilos para as setas de ordenação */
  .table th.sortable::after,
  .table th.sortable::before {
    content: "";
    position: absolute;
    right: 4px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .table th.sortable::before {
    bottom: 50%;
    margin-bottom: 1px;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-bottom: 5px solid;
  }

  .table th.sortable::after {
    top: 50%;
    margin-top: 1px;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid;
  }

  /* Mostra a seta correta dependendo da direção da ordenação */
  .table th.sort-asc::before,
  .table th.sort-desc::after {
    opacity: 1;
  }
  
  .market-price {
    font-style: italic;
    color: #a0a1b7; /* Um pouco mais claro que o text-muted-2 */
  }
</style>

<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card">
      <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseSummary" aria-expanded="true" aria-controls="collapseSummary">Summary</div>
      <div class="collapse show" id="collapseSummary">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Total</div>
              {% comment %} <div class="lbl">NAV</div> {% endcomment %}
              <div class="val">{{ summary.nav|currency_brl }}</div>
              <small class="text-muted-2">Caixa: {{ summary.cash|currency_brl }}</small>
              {% comment %} <small class="text-muted-2">Cash: {{ summary.cash|currency_brl }}</small> {% endcomment %}
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Inventário</div>
              {% comment %} <div class="lbl">MTM</div> {% endcomment %}
              <div class="val">{{ summary.mtm_value|currency_brl }}</div>
              <small class="text-muted-2">Custo: {{ summary.cost_basis|currency_brl }}</small>
              {% comment %} <small class="text-muted-2">Cost: {{ summary.cost_basis|currency_brl }}</small> {% endcomment %}
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">ROI</div>
              <div class="val">{{ summary.roi_percent|pct }}</div>
              <small class="text-muted-2">Investido: {{ summary.invested|currency_brl }}</small>
              {% comment %} <small class="text-muted-2">IC: {{ summary.invested|currency_brl }}</small> {% endcomment %}
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Profit</div>
              {% comment %} <div class="lbl">PnL</div> {% endcomment %}
              <div class="val">{{ summary.realized_pnl_value|currency_brl }}</div>
              <small class="text-muted-2">% médio: {{ summary.average_pnl_percent|pct }}</small>
              {% comment %} <small class="text-muted-2">Average PnL: {{ summary.average_pnl_percent|pct }}</small> {% endcomment %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseChart" aria-expanded="false" aria-controls="collapseChart">Profit history</div>
      <div class="collapse" id="collapseChart">
        <div class="card-body">
          <canvas id="pnlChart" style="height:200px; max-height:300px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  {% if not is_observer and not is_read_only %}
    {% include 'trades/add_trade_form.html' %}
  {% endif %}
</div>

<div class="card mt-3">
  <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapsePortfolio" aria-expanded="true" aria-controls="collapsePortfolio">Portfolio</div>
  <div class="collapse show" id="collapsePortfolio">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle" id="portfolioTable">
          <thead>
            <tr>
              <th class="sortable" data-sort-type="text">Item</th>
              <th class="sortable" data-sort-type="currency">Buy Price</th>
              <th class="sortable" data-sort-type="currency">Sell Price</th>
              <th class="sortable" data-sort-type="text">Buy Source</th>
              <th class="sortable" data-sort-type="text">Sell Source</th>
              <th class="sortable" data-sort-type="date">Buy Date</th>
              <th class="sortable" data-sort-type="date">Sell Date</th>
              <th class="sortable" data-sort-type="currency">Profit</th>
              {% comment %} <th class="sortable" data-sort-type="currency">PnL</th> {% endcomment %}
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for group in trade_data.grouped_open_trades %}
            <tr>
              <td class="fw-medium">
                <a href="#" class="text-white text-decoration-none" data-bs-toggle="modal" data-bs-target="#priceHistoryModal" data-trade-id="{{ group.trade.id }}" data-item-name="{{ group.trade.item_name }}">
                  {{ group.trade.item_name }} {% if group.quantity > 1 %}<span class="text-muted-2">({{ group.quantity }})</span>{% endif %}
                </a>
              </td>
              <td>{{ group.trade.buy_price|currency_brl }}</td>
              <td>
                {% if group.trade.market_price %}
                  <span class="market-price" title="Preço de mercado (Buff)">{{ group.trade.market_price|currency_brl }}</span>
                {% else %}
                  —
                {% endif %}
              </td>
              <td>{{ group.trade.get_buy_source_display }}</td>
              <td>{{ group.trade.get_sell_source_display|default:"" }}</td>
              <td>
                <span class="{{ group.trade.days_until_tradable|yesno:',cell-stale' }}">{{ group.trade.buy_date|date:"d/m/y" }}</span>
                {% if group.trade.days_until_tradable %}
                <small class="text-muted-2 fs-7">{{ group.trade.days_until_tradable }}d</small>
                {% endif %}
              </td>
              <td>{% if group.trade.sell_date %}{{ group.trade.sell_date|date:"d/m/y" }}{% endif %}</td>
              <td>—</td>
              <td>
                <button type="button" class="badge status-open badge-button" 
                  {% if not is_observer and not is_read_only %}data-bs-toggle="modal" data-bs-target="#sellModal-{{ group.trade.id }}"{% else %}disabled{% endif %}>
                  Open
                </button>
              </td>
            </tr>
            {% if not is_observer and not is_read_only %}
              {% include 'trades/edit_modal.html' with trade=group.trade %}
              {% include 'trades/sell_modal.html' with trade=group.trade %}
            {% endif %}
            {% endfor %}

            {% for trade in trade_data.closed_trades %}
            <tr>
              <td class="fw-medium">
                <a href="#" class="text-white text-decoration-none" data-bs-toggle="modal" data-bs-target="#priceHistoryModal" data-trade-id="{{ trade.id }}" data-item-name="{{ trade.item_name }}">
                  {{ trade.item_name }}
                </a>
              </td>
              <td>{{ trade.buy_price|currency_brl }}</td>
              <td>{{ trade.sell_price|currency_brl|default:"—" }}</td>
              <td>{{ trade.get_buy_source_display }}</td>
              <td>{{ trade.get_sell_source_display|default:"" }}</td>
              <td>{{ trade.buy_date|date:"d/m/y" }}</td>
              <td>
                {% if trade.sell_date %}
                  {{ trade.sell_date|date:"d/m/y" }}
                  {% if trade.days_until_payment is not None %}<small class="text-muted-2 fs-7">{{ trade.days_until_payment }}d</small>{% endif %}
                {% endif %}
              </td>
              <td>
                {% if trade.pnl_value is not None %}
                <span class="fw-semibold">{{ trade.pnl_value|currency_brl }} <small class="text-muted-2 fs-7">({{ trade.pnl_percent|pct }})</small></span>
                {% else %} — {% endif %}
              </td>
              <td>
                <button type="button" class="badge status-closed badge-button" 
                  {% if not is_observer and not is_read_only %}data-bs-toggle="modal" data-bs-target="#editModal-{{ trade.id }}"{% else %}disabled{% endif %}>
                  Closed
                </button>
              </td>
            </tr>
            {% if not is_observer and not is_read_only %}
              {% include 'trades/edit_modal.html' with trade=trade %}
              {% include 'trades/sell_modal.html' with trade=trade %}
            {% endif %}
            {% endfor %}

            {% if not trade_data.grouped_open_trades and not trade_data.closed_trades %}
            <tr><td colspan="9" class="text-center text-muted-2">No trades yet.</td></tr>
            {% endif %}
            
            {% if not show_history and more_trades %}
            <tr>
              <td colspan="9" class="text-center py-2">
                <a href="?{% if is_observer and selected_user %}user_id={{ selected_user.id }}&{% endif %}history=true" class="badge status-closed badge-button" style="text-decoration:none">Load all trades</a>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% if not is_observer and not is_read_only %}
<div class="card mt-3">
    {% include 'trades/investment_section.html' %}
</div>

<div class="card mt-3">
    <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseCashSource" aria-expanded="true" aria-controls="collapseCashSource">Cash per Source</div>
    <div class="collapse show" id="collapseCashSource">
        <div class="card-body">
            <canvas id="cashSourceChart" style="height:200px; max-height:300px;"></canvas>
        </div>
    </div>
</div>
{% endif %}
{% include 'trades/price_history_modal.html' %}


<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const pnlData = {{ pnl_data|safe }};
    if (pnlData && pnlData.length > 0) {
      const labels = pnlData.map(item => item.date);
      const values = pnlData.map(item => item.pnl);
      const ctx = document.getElementById('pnlChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{
          label: 'Accumulated PnL (R$)', data: values,
          borderColor: 'rgba(122, 43, 246, 0.8)', backgroundColor: 'rgba(122, 43, 246, 0.2)',
          tension: 0.3, fill: true,
        }]},
        options: { responsive: true, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false }}}
      });
    }

    const cashSourceData = {{ cash_per_source_data|safe }};
    if (cashSourceData && cashSourceData.labels.length > 0) {
        const ctx = document.getElementById('cashSourceChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: cashSourceData.labels,
                datasets: [{
                    label: 'Cash per Source (R$)',
                    data: cashSourceData.values,
                    backgroundColor: 'rgba(255, 78, 205, 0.2)',
                    borderColor: 'rgba(255, 78, 205, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    const portfolioTable = document.getElementById('portfolioTable');
    const headers = portfolioTable.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: 'asc' };

    headers.forEach((header, index) => {
      header.addEventListener('click', () => {
        const sortType = header.dataset.sortType;
        if (currentSort.column === index) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = index;
          currentSort.direction = 'asc';
        }
        sortTable(index, sortType, currentSort.direction);
        updateHeaderStyles();
      });
    });

    function updateHeaderStyles() {
      headers.forEach((header, index) => {
        header.classList.remove('sort-asc', 'sort-desc');
        if (index === currentSort.column) {
          header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    function parseValue(value, type) {
        if (type === 'currency') {
            if (value === '—') return -Infinity; // Trata valores vazios
            return parseFloat(value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
        }
        if (type === 'date') {
            if (!value) return null;
            const parts = value.trim().split(' ')[0].split('/');
            if (parts.length === 3) {
              return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return null;
        }
        return value.toLowerCase();
    }

    function sortTable(columnIndex, sortType, direction) {
      const tbody = portfolioTable.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      const sortedRows = rows.sort((a, b) => {
        const aVal = parseValue(a.cells[columnIndex].textContent, sortType);
        const bVal = parseValue(b.cells[columnIndex].textContent, sortType);

        if (aVal === null) return 1;
        if (bVal === null) return -1;
        
        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });

      tbody.innerHTML = '';
      sortedRows.forEach(row => tbody.appendChild(row));
    }
  });
</script>