<!--Main page for the Counterâ€‘Strike skin portfolio management application.

This template extends the base layout and organizes the page into three
logical sections: a summary of the portfolio at the top, a form for
adding new trades, and a table listing all trades with inline forms for
closing open positions. Bootstrap classes provide styling and
responsiveness.-->

{% extends "base.html" %}
{% load static %}

{% block content %}
  <!-- Summary Block -->
  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header">Summary</div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-md-3">
              <div class="h6 text-muted">Total Items</div>
              <div class="fs-4">{{ summary.total_items }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="h6 text-muted">Open</div>
              <div class="fs-4">{{ summary.open_positions }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="h6 text-muted">Closed</div>
              <div class="fs-4">{{ summary.closed_positions }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="h6 text-muted">Realized PnL</div>
              <div class="fs-4">{{ summary.total_realized_pnl }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Item Block -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header">Add Item</div>
        <div class="card-body">
          <form method="post" action="{% url 'index' %}" class="row g-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="add" />
            {{ add_form.non_field_errors }}
            <div class="col-12">
              <label class="form-label">Item Name</label>
              {{ add_form.item_name }}
            </div>
            <div class="col-6">
              <label class="form-label">Buy Price</label>
              {{ add_form.buy_price }}
            </div>
            <div class="col-6">
              <label class="form-label">Buy Source</label>
              {{ add_form.buy_source }}
            </div>
            <div class="col-12">
              <label class="form-label">Date of Purchase (optional)</label>
              {{ add_form.date_of_purchase }}
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary w-100">Add Trade</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Portfolio Block -->
  <div class="card shadow-sm mt-4">
    <div class="card-header">Portfolio</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Buy Price</th>
              <th>Sell Price</th>
              <th>Buy Source</th>
              <th>Sell Source</th>
              <th>Purchase Date</th>
              <th>Sold Date</th>
              <th>PnL</th>
              <th>Hold (days)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for trade in trades %}
              <tr class="{% if not trade.sell_price %}table-warning{% endif %}">
                <td>{{ trade.item_name }}</td>
                <td>{{ trade.buy_price }}</td>
                <td>
                  {% if trade.sell_price %}
                    {{ trade.sell_price }}
                  {% else %}
                    <form method="post" action="{% url 'index' %}" class="row g-1">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="sell" />
                      <input type="hidden" name="trade_id" value="{{ trade.id }}" />
                      <div class="col-12 col-md-4">{{ trade.sell_form.sell_price }}</div>
                      <div class="col-12 col-md-4">{{ trade.sell_form.sell_source }}</div>
                      <div class="col-12 col-md-4">{{ trade.sell_form.date_sold }}</div>
                      <div class="col-12 mt-1">
                        <button type="submit" class="btn btn-sm btn-success">Close</button>
                      </div>
                    </form>
                  {% endif %}
                </td>
                <td>{{ trade.get_buy_source_display }}</td>
                <td>{% if trade.sell_source %}{{ trade.get_sell_source_display }}{% endif %}</td>
                <td>{{ trade.date_of_purchase|date:"Y-m-d" }}</td>
                <td>{% if trade.date_sold %}{{ trade.date_sold|date:"Y-m-d" }}{% endif %}</td>
                <td>{% if trade.pnl is not None %}{{ trade.pnl }}{% endif %}</td>
                <td>
                  {% if trade.sell_price %}
                    <span class="badge bg-secondary">Closed</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Open</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="10" class="text-center text-muted">No trades yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}