{% extends "base.html" %}
{% load form_extras %}
{% load currency %}
{% load static %}

{% block content %}
  <!-- Summary -->
  <div class="row g-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header">Summary</div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Total Items</div>
              <!-- grande: R$ -->
              <div class="val">{{ summary.total_items_value|currency_brl }}</div>
              <!-- pequeno: Amnt -->
              <small class="text-muted-2">{{ summary.total_items_amnt }}</small>
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Open</div>
              <!-- grande: R$ -->
              <div class="val">{{ summary.open_positions_value|currency_brl }}</div>
              <!-- pequeno: Amnt -->
              <small class="text-muted-2">{{ summary.open_positions_amnt }}</small>
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Closed</div>
              <!-- grande: R$ -->
              <div class="val">{{ summary.closed_positions_value|currency_brl }}</div>
              <!-- pequeno: Amnt -->
              <small class="text-muted-2">{{ summary.closed_positions_amnt }}</small>
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Realized PnL</div>
              <!-- grande: R$ -->
              <div class="val">{{ summary.total_realized_pnl|currency_brl }}</div>
              <!-- pequeno: % -->
              <small class="text-muted-2">{{ summary.total_realized_pnl_pct|pct }}</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Item -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">Add Item</div>
        <div class="card-body">
          <form method="post" action="{% url 'index' %}" class="row g-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="add" />
            <div class="col-6">
              <label class="form-label">Item Name</label>
              {{ add_form.item_name|add_class:"form-control" }}
            </div>
            <div class="col-6">
              <label class="form-label">Date of Purchase</label>
              {{ add_form.date_of_purchase|add_class:"form-control" }}
            </div>
            <div class="col-6">
              <label class="form-label">Buy Price</label>
              {{ add_form.buy_price|add_class:"form-control" }}
            </div>
            <div class="col-6">
              <label class="form-label">Buy Source</label>
              {{ add_form.buy_source|add_class:"form-select" }}
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary w-100">Add Trade</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Portfolio -->
  <div class="card mt-4">
    <div class="card-header">Portfolio</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Buy Price</th>
              <th>Sell Price</th>
              <th>Buy Source</th>
              <th>Sell Source</th>
              <th>Purchase Date</th>
              <th>Sold Date</th>
              <th>PnL</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for trade in trades %}
              <tr>
                <td class="fw-medium">{{ trade.item_name }}</td>
                <td>{{ trade.buy_price|currency_brl }}</td>

                <!-- SELL PRICE (apenas valor ou traço) -->
                <td>
                  {% if trade.sell_price %}
                    {{ trade.sell_price|currency_brl }}
                  {% else %}
                    — 
                  {% endif %}
                </td>

                <td>{{ trade.get_buy_source_display }}</td>
                <td>{% if trade.sell_source %}{{ trade.get_sell_source_display }}{% endif %}</td>
                <td>{{ trade.date_of_purchase|date:"d/m/Y" }}</td>
                <td>{% if trade.date_sold %}{{ trade.date_sold|date:"d/m/Y" }}{% endif %}</td>

                <!-- PnL -->
                <td>
                  {% if trade.pnl_value is not None %}
                  <div class="d-flex flex-column">
                    <span class="fw-semibold">
                      {{ trade.pnl_value|currency_brl }}
                      <small class="text-muted-2 fs-7">({{ trade.pnl_percent|pct }})</small>
                    </span>
                  </div>
                  {% else %}
                    —
                  {% endif %}
                </td>

                <!-- STATUS / EDIT -->
                <td>
                  {% if trade.sell_price %}
                    <span class="badge status-closed">Closed</span>
                  {% else %}
                    <button type="button"
                            class="badge status-closed badge-button"
                            data-bs-toggle="modal"
                            data-bs-target="#sellModal-{{ trade.id }}">
                      Edit
                    </button>
                  {% endif %}
                </td>
              </tr>

              <!-- MODAL para itens abertos -->
              {% if not trade.sell_price %}
                <div class="modal fade" id="sellModal-{{ trade.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content modal-dark">
                      <div class="modal-header">
                        <h5 class="modal-title">{{ trade.item_name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>

                      <form method="post" action="{% url 'index' %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="sell">
                        <input type="hidden" name="trade_id" value="{{ trade.id }}">

                        <div class="modal-body">
                          <div class="mb-3">
                            <label class="form-label">Sell Price</label>
                            {{ trade.sell_form.sell_price|add_class:"form-control"}}
                          </div>
                          <div class="mb-3">
                            <label class="form-label">Sell Source</label>
                            {{ trade.sell_form.sell_source|add_class:"form-select"}}
                          </div>
                          <div class="mb-3">
                            <label class="form-label">Sold Date</label>
                            {{ trade.sell_form.date_sold|add_class:"form-control"}}
                          </div>
                        </div>

                        <div class="modal-footer">
                          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-primary">Save & Close</button>
                        </div>
                      </form>

                    </div>
                  </div>
                </div>
              {% endif %}

            {% empty %}
              <tr><td colspan="9" class="text-center text-muted-2">No trades yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}
