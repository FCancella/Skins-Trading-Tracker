{% extends "base.html" %}
{% load form_extras %}
{% load currency %}
{% load static %}

{% block content %}
<div class="row g-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseSummary" aria-expanded="true" aria-controls="collapseSummary">Summary</div>
      <div class="collapse show" id="collapseSummary">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Custo Total</div>
              <div class="val">{{ summary.cost_basis|currency_brl }}</div>
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">MTM</div>
              <div class="val">{{ summary.mtm_value|currency_brl }}</div>
              <small class="text-muted-2">IC: {{ summary.invested|currency_brl }}</small>
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">PnL Realizado</div>
              <div class="val">{{ summary.realized_pnl_value|currency_brl }}</div>
              <small class="text-muted-2">ROI: {{ summary.roi_percent|pct }}</small>
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">PnL Médio (Vendas)</div>
              <div class="val">{{ summary.average_pnl_percent|pct }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseChart" aria-expanded="false" aria-controls="collapseChart">Realized PnL over time</div>
      <div class="collapse" id="collapseChart">
        <div class="card-body">
          <canvas id="pnlChart" style="height:200px; max-height:300px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseAddItem" aria-expanded="true" aria-controls="collapseAddItem">Add Item</div>
      <div class="collapse show" id="collapseAddItem">
        <div class="card-body">
          <form method="post" action="{% url 'index' %}" class="row g-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="add" />
            <div class="col-6">
              <label class="form-label">Item Name</label>
              {{ add_form.item_name|add_class:"form-control" }}
            </div>
            <div class="col-6">
              <label class="form-label">Date of Purchase</label>
              {{ add_form.date_of_purchase|add_class:"form-control" }}
            </div>
            <div class="col-6">
              <label class="form-label">Buy Price</label>
              {{ add_form.buy_price|add_class:"form-control" }}
            </div>
            <div class="col-6">
              <label class="form-label">Buy Source</label>
              {{ add_form.buy_source|add_class:"form-select" }}
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary w-100">Add Trade</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapsePortfolio" aria-expanded="true" aria-controls="collapsePortfolio">Portfolio</div>
  <div class="collapse show" id="collapsePortfolio">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Buy Price</th>
              <th>Sell Price</th>
              <th>Buy Source</th>
              <th>Sell Source</th>
              <th>Purchase Date</th>
              <th>Sold Date</th>
              <th>PnL</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for trade in trades %}
            <tr>
              <td class="fw-medium">{{ trade.item_name }}</td>
              <td>{{ trade.buy_price|currency_brl }}</td>
              <td>{% if trade.sell_price %}{{ trade.sell_price|currency_brl }}{% else %}—{% endif %}</td>
              <td>{{ trade.get_buy_source_display }}</td>
              <td>{% if trade.sell_source %}{{ trade.get_sell_source_display }}{% endif %}</td>
              <td>
                {% if trade.is_stale_purchase %}
                  <span class="cell-stale">{{ trade.date_of_purchase|date:"d/m/Y" }}</span>
                {% else %}
                  {{ trade.date_of_purchase|date:"d/m/Y" }}
                {% endif %}
                {% if trade.days_until_stale is not None %}
                  <small class="text-muted-2 fs-7">{{ trade.days_until_stale }}d</small>
                {% endif %}
              </td>
              <td>{% if trade.date_sold %}{{ trade.date_sold|date:"d/m/Y" }}{% endif %}</td>
              <td>
                {% if trade.pnl_value is not None %}
                <div class="d-flex flex-column">
                  <span class="fw-semibold">
                    {{ trade.pnl_value|currency_brl }}
                    <small class="text-muted-2 fs-7">({{ trade.pnl_percent|pct }})</small>
                  </span>
                </div>
                {% else %}
                —
                {% endif %}
              </td>
              <td>
                <button type="button" class="badge status-{{ trade.sell_price|yesno:'closed,open' }} badge-button" data-bs-toggle="modal" data-bs-target="#editModal-{{ trade.id }}">
                  {{ trade.sell_price|yesno:'Closed,Open' }}
                </button>
              </td>
            </tr>

            <div class="modal fade" id="editModal-{{ trade.id }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content modal-dark">
                  <div class="modal-header">
                    <h5 class="modal-title">Edit: {{ trade.item_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  {% if trade.sell_price is None %}
                  <form method="post" action="{% url 'index' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="sell">
                    <input type="hidden" name="trade_id" value="{{ trade.id }}">
                    <div class="modal-body">
                      <div class="mb-3">
                        <label class="form-label">Sell Price</label>
                        {{ trade.edit_form.sell_price|add_class:"form-control"}}
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Sell Source</label>
                        {{ trade.edit_form.sell_source|add_class:"form-select"}}
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Sold Date</label>
                        {{ trade.edit_form.date_sold|add_class:"form-control"}}
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Save & Close</button>
                    </div>
                  </form>
                  {% else %}
                  <form method="post" action="{% url 'index' %}" class="row g-3 m-0">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="trade_id" value="{{ trade.id }}">
                    <div class="modal-body">
                      <div class="row g-3">
                        <div class="col-12">
                          <label class="form-label">Item Name</label>
                          {{ trade.edit_form.item_name }}
                        </div>
                        <div class="col-6">
                          <label class="form-label">Buy Price</label>
                          {{ trade.edit_form.buy_price }}
                        </div>
                        <div class="col-6">
                          <label class="form-label">Buy Source</label>
                          {{ trade.edit_form.buy_source }}
                        </div>
                        <div class="col-12">
                          <label class="form-label">Date of Purchase</label>
                          {{ trade.edit_form.date_of_purchase }}
                        </div>
                        <hr class="hr-soft" />
                        <div class="col-6">
                          <label class="form-label">Sell Price</label>
                          {{ trade.edit_form.sell_price }}
                        </div>
                        <div class="col-6">
                          <label class="form-label">Sell Source</label>
                          {{ trade.edit_form.sell_source }}
                        </div>
                        <div class="col-12">
                          <label class="form-label">Date Sold</label>
                          {{ trade.edit_form.date_sold }}
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                  </form>
                  {% endif %}
                </div>
              </div>
            </div>

            {% empty %}
            <tr>
              <td colspan="9" class="text-center text-muted-2">No trades yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#collapseInvestments" aria-expanded="false" aria-controls="collapseInvestments">Investments</div>
  <div class="collapse" id="collapseInvestments">
    <div class="card-body">
      <h5 class="mb-3">Add Investment</h5>
      <form method="post" action="{% url 'index' %}" class="row g-3">
        {% csrf_token %}
        <input type="hidden" name="action" value="invest">
        <div class="col-md-3">
          <label class="form-label">Amount</label>
          {{ investment_form.amount }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Description</label>
          {{ investment_form.description }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Date</label>
          {{ investment_form.date }}
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary w-100">Add Investment</button>
        </div>
      </form>

      <hr class="hr-soft my-4">

      <h5 class="mb-3">History</h5>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Amount</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            {% for investment in investments %}
            <tr>
              <td>{{ investment.date|date:"d/m/Y" }}</td>
              <td>{{ investment.amount|currency_brl }}</td>
              <td>{{ investment.description }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="text-center text-muted-2">No investments yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Get data from Django context
  const pnlData = {{ pnl_data|safe }};

  // Extract labels (dates) and values (daily_pnl)
  const labels = pnlData.map(item => item.date);
  const values = pnlData.map(item => item.pnl);

  const ctx = document.getElementById('pnlChart').getContext('2d');
  const pnlChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Daily PnL (R$)',
        data: values,
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.3, // smooth curve
        fill: true,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true
        },
        tooltip: {
          mode: 'index',
          intersect: false,
        }
      },
    }
  });
</script>

{% endblock %}