{% extends "base.html" %}
{% load form_extras %}
{% load static %}

{% block content %}
  <!-- Summary -->
  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <div class="card">
        <div class="card-header">Summary</div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Total Items</div>
              <div class="val">{{ summary.total_items }}</div>
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Open</div>
              <div class="val">{{ summary.open_positions }}</div>
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Closed</div>
              <div class="val">{{ summary.closed_positions }}</div>
            </div>
            <div class="col-6 col-md-3 kpi">
              <div class="lbl">Realized PnL</div>
              <div class="val">{{ summary.total_realized_pnl|floatformat:2 }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Item -->
    <div class="col-12 col-lg-4">
      <div class="card">
        <div class="card-header">Add Item</div>
        <div class="card-body">
          <form method="post" action="{% url 'index' %}" class="row g-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="add" />
            <div class="col-12">
              <label class="form-label">Item Name</label>
              {{ add_form.item_name|add_class:"form-control" }}
            </div>
            <div class="col-6">
              <label class="form-label">Buy Price</label>
              {{ add_form.buy_price|add_class:"form-control" }}
            </div>
            <div class="col-6">
              <label class="form-label">Buy Source</label>
              {{ add_form.buy_source|add_class:"form-select" }}
            </div>
            <div class="col-12">
              <label class="form-label">Date of Purchase (optional)</label>
              {{ add_form.date_of_purchase|add_class:"form-control" }}
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary w-100">Add Trade</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Portfolio -->
  <div class="card mt-4">
    <div class="card-header">Portfolio</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Buy Price</th>
              <th>Sell Price</th>
              <th>Buy Source</th>
              <th>Sell Source</th>
              <th>Purchase Date</th>
              <th>Sold Date</th>
              <th>PnL</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for trade in trades %}
              <tr>
                <td class="fw-medium">{{ trade.item_name }}</td>
                <td>{{ trade.buy_price|floatformat:2 }}</td>
                <td>
                  {% if trade.sell_price %}
                    {{ trade.sell_price|floatformat:2 }}
                  {% else %}
                    <form method="post" action="{% url 'index' %}" class="row g-1">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="sell" />
                      <input type="hidden" name="trade_id" value="{{ trade.id }}" />
                      <div class="col-12 col-md-4">{{ trade.sell_form.sell_price|add_class:"form-control form-control-sm" }}</div>
                      <div class="col-12 col-md-4">{{ trade.sell_form.sell_source|add_class:"form-select form-select-sm" }}</div>
                      <div class="col-12 col-md-4">{{ trade.sell_form.date_sold|add_class:"form-control form-control-sm" }}</div>
                      <div class="col-12 mt-1">
                        <button type="submit" class="btn btn-close-trade btn-sm">Close</button>
                      </div>
                    </form>
                  {% endif %}
                </td>
                <td>{{ trade.get_buy_source_display }}</td>
                <td>{% if trade.sell_source %}{{ trade.get_sell_source_display }}{% endif %}</td>
                <td>{{ trade.date_of_purchase|date:"d/m/Y" }}</td>
                <td>{% if trade.date_sold %}{{ trade.date_sold|date:"d/m/Y" }}{% endif %}</td>
                <td>
                  {% if trade.pnl is not None %}
                    <span class="{% if trade.pnl > 0 %}text-success{% elif trade.pnl < 0 %}text-danger{% else %}text-muted{% endif %}">
                      {{ trade.pnl|floatformat:2 }}
                    </span>
                  {% endif %}
                </td>
                <td>
                  {% if trade.sell_price %}
                    <span class="badge status-closed">Closed</span>
                  {% else %}
                    <span class="badge status-open">Open</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="9" class="text-center text-muted-2">No trades yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}
